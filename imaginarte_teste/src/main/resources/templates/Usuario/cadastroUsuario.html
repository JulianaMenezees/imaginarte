<!DOCTYPE html>
<html lang="pt" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de Usuário</title>
    <link rel="stylesheet" th:href="@{/css/cadastroUsuarios.css}">
</head>
<body>

<div class="container">
    <div class="formulario">
        <h2>Cadastro de Usuário</h2>

        <form th:action="@{/usuario/cadastroUsuario}" th:object="${usuario}" method="post" onsubmit="return validarFormulario(this)">

            <!-- Wrapper para transição -->
            <div class="step-container">
                <div class="steps-wrapper" id="stepsWrapper">

                    <!-- Etapa 1: Dados Pessoais -->
                    <div class="step" id="step1">
                        <div class="mb-3">
                            <input class="form-control" th:field="*{nome}" type="text" placeholder="Nome Completo" required>
                        </div>

                        <div class="mb-3">
                            <input class="form-control" th:field="*{email}" type="email" placeholder="Email" required>
                            <span th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <input class="form-control" th:field="*{senha}" id="senha" type="password" placeholder="Senha" required>
                        </div>

                        <div class="mb-3">
                            <input class="form-control" id="confirmacao" type="password" placeholder="Confirme a Senha" required>
                        </div>

                        <div class="mb-3">
                            <input class="form-control" th:field="*{cpf}" type="text" placeholder="CPF" oninput="formatCPF(this)" required>
                            <span th:if="${#fields.hasErrors('cpf')}" th:errors="*{cpf}" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <input class="form-control" th:field="*{dataNascimento}" type="date" required>
                        </div>

                        <div class="mb-3">
                            <select class="form-control" th:field="*{genero}" required>
                                <option value="">Selecione o Gênero</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>

                        <button type="button" class="btn btn-primary" onclick="nextStep()">Próximo</button>
                    </div>

                    <!-- Etapa 2: Endereço -->
                    <div class="step" id="step2">
                        <div class="mb-3">
                            <input class="form-control" th:field="*{cep}" id="cep" type="text" placeholder="CEP" required>
                        </div>

                        <div class="mb-3">
                            <input class="form-control" th:field="*{logradouro}" id="logradouro" type="text" placeholder="Logradouro" required>
                        </div>

                        <div class="mb-3">
                            <input class="form-control" th:field="*{numero}" type="text" placeholder="Número" required>
                        </div>

                        <div class="mb-3">
                            <input class="form-control" th:field="*{complemento}" type="text" placeholder="Complemento">
                        </div>

                        <div class="mb-3">
                            <input class="form-control" th:field="*{bairro}" id="bairro" type="text" placeholder="Bairro" required>
                        </div>

                        <div class="mb-3">
                            <input class="form-control" th:field="*{cidade}" id="cidade" type="text" placeholder="Cidade" required>
                        </div>

                        <div class="mb-3">
                            <input class="form-control" th:field="*{uf}" id="uf" type="text" placeholder="UF" maxlength="2" required>
                        </div>

                        <button type="button" class="btn btn-primary" onclick="prevStep()">Voltar</button>
                        <button type="submit" class="btn btn-primary">Cadastrar</button>
                    </div>

                </div>
            </div>
        </form>
    </div>
</div>

<!-- Scripts -->
<script>
    let currentStep = 0;

    function nextStep() {
        currentStep = 1;
        updateStep();
    }

    function prevStep() {
        currentStep = 0;
        updateStep();
    }

    function updateStep() {
        const wrapper = document.getElementById("stepsWrapper");
        wrapper.style.transform = `translateX(-${currentStep * 350}px)`;
    }

    function formatCPF(cpfField) {
        let cpf = cpfField.value.replace(/\D/g, '');
        if (cpf.length > 11) cpf = cpf.slice(0, 11);
        if (cpf.length > 9) cpf = cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, "$1.$2.$3-$4");
        else if (cpf.length > 6) cpf = cpf.replace(/(\d{3})(\d{3})(\d{1,3})/, "$1.$2.$3");
        else if (cpf.length > 3) cpf = cpf.replace(/(\d{3})(\d{1,3})/, "$1.$2");
        cpfField.value = cpf;
    }

    function validarCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');
        if (cpf.length !== 11 || /(\d)\1{10}/.test(cpf)) return false;
        let soma = 0, peso = 10;
        for (let i = 0; i < 9; i++) soma += parseInt(cpf[i]) * peso--;
        let resto = soma % 11;
        if (parseInt(cpf[9]) !== (resto < 2 ? 0 : 11 - resto)) return false;
        soma = 0; peso = 11;
        for (let i = 0; i < 10; i++) soma += parseInt(cpf[i]) * peso--;
        resto = soma % 11;
        return parseInt(cpf[10]) === (resto < 2 ? 0 : 11 - resto);
    }

    function validarFormulario(form) {
        let cpf = form.querySelector("[name='cpf']").value;
        let senha = document.getElementById("senha").value;
        let confirmacao = document.getElementById("confirmacao").value;

        if (!validarCPF(cpf)) {
            alert("CPF inválido!");
            return false;
        }

        if (senha !== confirmacao) {
            alert("As senhas não coincidem!");
            return false;
        }

        return true;
    }

    // API ViaCEP
    document.getElementById("cep").addEventListener("blur", function () {
        const cep = this.value.replace(/\D/g, '');

        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById("logradouro").value = data.logradouro || '';
                        document.getElementById("bairro").value = data.bairro || '';
                        document.getElementById("cidade").value = data.localidade || '';
                        document.getElementById("uf").value = data.uf || '';
                    } else {
                        alert("CEP não encontrado.");
                    }
                })
                .catch(() => alert("Erro ao buscar o CEP."));
        }
    });
</script>

</body>
</html>
